name: Deploy ILAI to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  # ========================================
  # Build and Push Frontend
  # ========================================
  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/web
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          echo "=== BUILD METRICS ==="
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-frontend:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-frontend:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build Auth Service
  # ========================================
  build-auth:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build auth service
        working-directory: services/muse-auth-service
        run: mvn clean package -DskipTests -q
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push auth image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-auth-service
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-auth:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-auth:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-auth:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build Notes Service
  # ========================================
  build-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build notes service
        working-directory: services/muse-notes-service
        run: mvn clean package -DskipTests -q
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push notes image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-notes-service
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-notes:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-notes:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-notes:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build Social Service
  # ========================================
  build-social:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build social service
        working-directory: services/muse-social-service
        run: mvn clean package -DskipTests -q
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push social image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-social-service
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-social:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-social:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-social:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build AI Service
  # ========================================
  build-ai:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build ai service
        working-directory: services/muse-ai-service
        run: mvn clean package -DskipTests -q
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push ai image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-ai-service
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-ai:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-ai:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-ai:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build Labs Service (Python Compute Engine)
  # ========================================
  build-labs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "After cleanup:"
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push labs image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-compute-engine
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-labs:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-labs:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-labs:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Build Agentic RAG Service (Python)
  # ========================================
  build-agentic-rag:
    if: false  # DISABLED: Takes 30+ minutes, optional service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "After cleanup:"
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push agentic-rag image
        uses: docker/build-push-action@v5
        with:
          context: ./services/muse-agentic-rag
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/ilai-agentic-rag:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image size
        run: |
          docker pull ${{ env.IMAGE_PREFIX }}/ilai-agentic-rag:latest
          docker images ${{ env.IMAGE_PREFIX }}/ilai-agentic-rag:latest --format "Image: {{.Repository}}:{{.Tag}} | Size: {{.Size}}"

  # ========================================
  # Deploy to EC2
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-auth, build-notes, build-social, build-ai, build-labs]
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/ilai-001
            
            # Create .env file from GitHub Secrets
            cat > .env << 'EOL'
            # Database Configuration
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_URL=${{ secrets.DB_URL }}
            DB_MAX_POOL_SIZE=${{ secrets.DB_MAX_POOL_SIZE }}
            DB_MIN_IDLE=${{ secrets.DB_MIN_IDLE }}
            
            # JWT Security Secrets
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            
            # Email Configuration
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            
            # AI Configuration
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
            LLM_PROVIDER=${{ secrets.LLM_PROVIDER }}
            TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
            
            # Frontend URL
            FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }}
            
            # Keycloak Configuration
            KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
            KEYCLOAK_ISSUER_URI=${{ secrets.KEYCLOAK_ISSUER_URI }}
            KEYCLOAK_JWKS_URI=${{ secrets.KEYCLOAK_JWKS_URI }}
            VITE_KEYCLOAK_URL=${{ secrets.VITE_KEYCLOAK_URL }}
            VITE_KEYCLOAK_REALM=${{ secrets.VITE_KEYCLOAK_REALM }}
            VITE_KEYCLOAK_CLIENT_ID=${{ secrets.VITE_KEYCLOAK_CLIENT_ID }}
            
            # Google OAuth2
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            
            # Application Settings
            EMAIL_VERIFICATION_ENABLED=${{ secrets.EMAIL_VERIFICATION_ENABLED }}
            SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}
            VITE_AUTH_MODE=${{ secrets.VITE_AUTH_MODE }}
            EOL
            
            # Login to GHCR
            echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u prasanth-alaparthi --password-stdin
            
            # Pull latest images using docker-compose
            sudo docker-compose pull
            
            # Restart services with docker-compose
            # -d: detached mode
            # --remove-orphans: remove containers for services not defined in the compose file (Academic/Quantum)
            sudo docker-compose up -d --remove-orphans
            
            # Verify and show sizes
            echo "=== DEPLOYED IMAGE SIZES ==="
            sudo docker images --format "{{.Repository}}:{{.Tag}} | {{.Size}}" | grep ilai
            
            sleep 10
            sudo docker-compose ps
            
            echo "Deployment complete!"
