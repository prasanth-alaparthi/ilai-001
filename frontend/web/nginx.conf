server {
    listen 80;
    server_name localhost;

    # Use Docker's internal DNS resolver with short timeout
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    root /usr/share/nginx/html;
    index index.html;

    # Serve static files (SPA)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ==========================================
    # REQUIRED SERVICES (Auth + Notes)
    # ==========================================
    
    # OAuth2 endpoints - rewrite path for Spring Security
    location /api/auth/oauth2/ {
        set $auth_upstream http://muse-auth-service:8081;
        rewrite ^/api/auth/oauth2/(.*)$ /oauth2/$1 break;
        proxy_pass $auth_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OAuth2 callback endpoint
    location /api/auth/login/oauth2/ {
        set $auth_upstream http://muse-auth-service:8081;
        rewrite ^/api/auth/login/oauth2/(.*)$ /login/oauth2/$1 break;
        proxy_pass $auth_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Auth Service
    location /api/auth {
        set $auth_upstream http://muse-auth-service:8081;
        proxy_pass $auth_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/users {
        set $auth_upstream http://muse-auth-service:8081;
        proxy_pass $auth_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/parents {
        set $auth_upstream http://muse-auth-service:8081;
        proxy_pass $auth_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Notes Service (Core)
    location /api/notes {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/notebooks {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/sections {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/share {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Journal (in Notes)
    location /api/journal {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/journals {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Calendar (in Notes)
    location /api/calendar {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Labs (in Notes)
    location /api/labs {
        set $notes_upstream http://muse-notes-service:8082;
        proxy_pass $notes_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ==========================================
    # CORE SOLVER (Unified Math/Physics/Chemistry)
    # ==========================================
    
    # Core Solver - SymPy powered
    location /api/solver {
        set $solver_upstream http://muse-compute-engine:8000;
        proxy_pass $solver_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
    }

    # Legacy physics endpoint (backwards compat)
    location /api/physics {
        set $solver_upstream http://muse-compute-engine:8000;
        proxy_pass $solver_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
    }

    # Legacy chemistry endpoint (backwards compat)
    location /api/chemistry {
        set $solver_upstream http://muse-compute-engine:8000;
        proxy_pass $solver_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
    }

    # Compute Engine Health
    location /api/compute/health {
        set $solver_upstream http://muse-compute-engine:8000;
        rewrite ^/api/compute/health$ /health break;
        proxy_pass $solver_upstream;
        proxy_set_header Host $host;
    }

    # ==========================================
    # WEBSOCKET (Real-time Variable Sync)
    # ==========================================
    
    location /ws/ {
        set $solver_upstream http://muse-compute-engine:8000;
        proxy_pass $solver_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ==========================================
    # OPTIONAL SERVICES (Fail gracefully)
    # ==========================================

    # AI Service (Optional)
    location /api/ai {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/assistant {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/personalization {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/agents {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/search {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/access {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/gamification {
        set $ai_upstream http://muse-ai-service:8088;
        proxy_pass $ai_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    # Social Service (Optional)
    location /api/feed {
        set $social_upstream http://muse-social-service:8083;
        proxy_pass $social_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/chat {
        set $social_upstream http://muse-social-service:8083;
        proxy_pass $social_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /ws-chat {
        set $social_upstream http://muse-social-service:8083;
        proxy_pass $social_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    # Academic Service (Optional)
    location /api/academic {
        set $academic_upstream http://muse-academic-service:8087;
        proxy_pass $academic_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/parental {
        set $academic_upstream http://muse-academic-service:8087;
        proxy_pass $academic_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/clubs {
        set $academic_upstream http://muse-academic-service:8087;
        proxy_pass $academic_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/classroom {
        set $academic_upstream http://muse-academic-service:8087;
        proxy_pass $academic_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /api/assignments {
        set $academic_upstream http://muse-academic-service:8087;
        proxy_pass $academic_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    # Keycloak (Optional)
    location /realms/ {
        set $kc_upstream http://keycloak:8080;
        proxy_pass $kc_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    location /resources/ {
        set $kc_upstream http://keycloak:8080;
        proxy_pass $kc_upstream;
        proxy_set_header Host $host;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    # Quantum Service (Optional)
    location /api/quantum {
        set $quantum_upstream http://muse-quantum-service:8092;
        proxy_pass $quantum_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        error_page 502 503 504 = @service_unavailable;
    }

    # ==========================================
    # AGENTIC RAG SERVICE (LangGraph + Tavily)
    # ==========================================
    
    # Agentic RAG - SSE Streaming search
    location /api/rag {
        set $rag_upstream http://muse-agentic-rag:8001;
        proxy_pass $rag_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 10s;
        proxy_read_timeout 120s;
        
        # SSE streaming support
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
        
        error_page 502 503 504 = @service_unavailable;
    }

    # Error handler for unavailable services
    location @service_unavailable {
        default_type application/json;
        return 503 '{"error": "Service temporarily unavailable", "code": "SERVICE_UNAVAILABLE"}';
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
