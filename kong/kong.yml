_format_version: "3.0"
_transform: true

# Kong API Gateway Configuration for ILAI
# Centralized routing with authentication, rate limiting, and CORS

services:
  # Auth Service
  - name: auth-service
    url: http://muse-auth-service:8081
    routes:
      - name: auth-routes
        paths:
          - /api/auth
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:5173
            - http://localhost
            - https://ilai.co.in
            - https://www.ilai.co.in
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
            - X-Requested-With
            - Accept
          credentials: true
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # Notes Service
  - name: notes-service
    url: http://muse-notes-service:8082
    routes:
      - name: notes-routes
        paths:
          - /api/notes
          - /api/notebooks
          - /api/sections
          - /api/calendar
          - /api/journal
          - /api/journals
          - /api/templates
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:5173
            - http://localhost
            - https://ilai.co.in
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
          credentials: true
      - name: rate-limiting
        config:
          minute: 200
          policy: local

  # AI Service
  - name: ai-service
    url: http://muse-ai-service:8088
    routes:
      - name: ai-routes
        paths:
          - /api/ai
          - /api/assistant
          - /api/access
          - /api/gamification
          - /api/personalization
          - /api/agents
          - /api/search
          - /api/doubt-solver
          - /api/voice
          - /api/flashcards
          - /api/payments
          - /api/research
          - /api/notebook
          - /api/billing
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:5173
            - http://localhost
            - https://ilai.co.in
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
          credentials: true
      - name: rate-limiting
        config:
          minute: 60
          policy: local

  # Academic Service
  - name: academic-service
    url: http://muse-academic-service:8087
    routes:
      - name: academic-routes
        paths:
          - /api/academic
          - /api/clubs
          - /api/parental
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # Social Service
  - name: social-service
    url: http://muse-social-service:8083
    routes:
      - name: social-routes
        paths:
          - /api/chat
          - /api/feed
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 150
          policy: local

  # Keycloak (for direct access if needed)
  - name: keycloak-service
    url: http://keycloak:8080
    routes:
      - name: keycloak-routes
        paths:
          - /auth
          - /realms
        strip_path: false

# Global Plugins
plugins:
  # Global rate limiting fallback
  - name: rate-limiting
    config:
      minute: 1000
      hour: 10000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Request size limiting (WAF-like protection)
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  # IP Restriction (optional - uncomment to enable)
  # - name: ip-restriction
  #   config:
  #     deny:
  #       - 1.2.3.4

# Upstream health checks
upstreams:
  - name: auth-upstream
    targets:
      - target: muse-auth-service:8081
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3

  - name: notes-upstream
    targets:
      - target: muse-notes-service:8082
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
